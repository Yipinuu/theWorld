<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" content="是游悠品意的个人站点，现在主要是技术文章和个人作品发表"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="照东方万八千世界" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>在railsAPP中上传图片 - 照东方万八千世界</title><link rel="stylesheet" href="/css/main.css" type="text/css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">照东方万八千世界</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li><li class="head-nav__item"><a href="http://Lofter.yipinuu.com" class="head-nav__link">Photo</a></li><li class="head-nav__item"><a href="/about.html" class="head-nav__link">About</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2015-09-08T07:19:42.000Z" class="post__time">九月 8, 2015</time><h1 class="post__title"><a href="/2015/09/在railsAPP中上传图片/">在railsAPP中上传图片</a></h1></header><div class="post__main echo"><h2 id="前言">前言</h2><p>新任务是实现上传图片的功能。<br>首先我实现了上传单张图片，删除单张图片，然后是上传多张图片，最后实现使用AJAX上传图片。<br>使用的gem有：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Upload <span class="keyword">files</span> in your Ruby applications,</span><br><span class="line"># <span class="built_in">map</span> them <span class="keyword">to</span> <span class="keyword">a</span> <span class="built_in">range</span> of ORMs, store them <span class="keyword">on</span> different backends.</span><br><span class="line"># http<span class="variable">s:</span>//github.<span class="keyword">com</span>/carrierwaveuploader/carrierwave</span><br><span class="line">gem <span class="string">'carrierwave'</span>, <span class="string">'~&gt;0.10.0'</span></span><br><span class="line"></span><br><span class="line"># Rails jQuery <span class="keyword">file</span> uploads via standard Rails <span class="string">"remote: true"</span> forms.</span><br><span class="line"># http<span class="variable">s:</span>//github.<span class="keyword">com</span>/JangoSteve/remotipart</span><br><span class="line">gem <span class="string">'remotipart'</span>, <span class="string">'~&gt; 1.2'</span></span><br></pre></td></tr></table></figure>
<h2 id="上传单张图片">上传单张图片</h2><p>首先配置routes.rb</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resources <span class="symbol">:images</span>, <span class="symbol">only:</span> <span class="symbol">:destroy</span></span><br></pre></td></tr></table></figure>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">post</span> admin_images_path</span><br><span class="line"><span class="built_in">delete</span> admin_image_path</span><br></pre></td></tr></table></figure>
<p>在写上传单张图片的功能时，是直接使用了已有的Projectscontroller和view。<br>因为你不会想要因为需要上传一张图片，而重新读取一次页面资源。<br>我在拥有project表单的template中加入了</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"form-group"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">label</span> <span class="attribute">class</span>=<span class="value">"col-md-3 control-label"</span>&gt;</span>Lanscape<span class="tag">&lt;/<span class="title">label</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"col-md-9"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">%=</span> <span class="attribute">file_field</span> <span class="attribute">:landscape</span>, <span class="attribute">:uploaded_image</span>, <span class="attribute">multiple:</span> <span class="attribute">true</span> %&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 下面的代码是用来引用用来显示已有图片的template的 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"col-md-offset-1 col-md-11"</span> <span class="attribute">id</span>=<span class="value">"landscapes_list"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">%=</span> <span class="attribute">render</span> '<span class="attribute">admin</span>/<span class="attribute">images</span>/<span class="attribute">landscapes</span>' %&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>为什么要这么写呢？因为，我们的数据是单独的image数据表进行储存的。<br>我们期待给后台传递的params中，:landscape，是独立的。并非依赖原project存在的。</p>
<p>然后是_landscaps.html.erb，我没写全代码，但是能懂意思就可以。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"row project"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">%</span> @<span class="attribute">project.landscapes.each</span> <span class="attribute">do</span> |<span class="attribute">landscape</span>| %&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">%=</span> <span class="attribute">image_tag</span> <span class="attribute">landscape.uploaded_image</span> %&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 下面的代码是删除图片功能的，我先一起放了 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">%=</span> <span class="attribute">link_to</span> <span class="attribute">admin_image_path</span>(<span class="attribute">landscape.id</span>), <span class="attribute">method:</span> <span class="attribute">:delete</span>,</span><br><span class="line">      <span class="attribute">data:</span> &#123;<span class="attribute">confirm:</span> "<span class="attribute">Do</span> <span class="attribute">you</span> <span class="attribute">want</span> <span class="attribute">destory</span> <span class="attribute">this</span> <span class="attribute">project</span>"&#125; <span class="attribute">do</span> %&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="title">i</span> <span class="attribute">class</span>=<span class="value">"fa fa-trash"</span>&gt;</span><span class="tag">&lt;/<span class="title">i</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">%</span> <span class="attribute">end</span> %&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">%</span> <span class="attribute">end</span> %&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>它将project下的所有的landcape都拿出来并一一显示了。</p>
<p>我们有了 routes 有了 view，现在只剩下了 controller 就可以解决单张图片的问题了。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span></span></span><br><span class="line">  <span class="keyword">if</span> params[<span class="symbol">:landscape</span>]</span><br><span class="line">    params[<span class="symbol">:landscape</span>][<span class="symbol">:uploaded_image</span>].each <span class="keyword">do</span> |num, image|</span><br><span class="line">     <span class="variable">@project</span>.landscapes.create(<span class="symbol">uploaded_image:</span> image)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 跳转的方式将按照原来方法</span></span><br><span class="line">  ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span></span></span><br><span class="line">  <span class="comment"># 与create相同</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>然后我们就可以发现，现在已经可以上传单张图片了。</p>
<p>TBC.</p>
</div><footer class="post__foot u-cf"><a href="/2015/09/在railsAPP中上传图片/#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article><div class="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript></div></div></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2015 游悠品意</div><menu class="page-menu u-fr"><li class="page-menu__item"><span title="Previous" class="page-menu__link icon-arrow-left page-menu__link--disabled"></span></li><li class="page-menu__item"><a title="Next" href="/2015/09/devise实践笔记/" class="page-menu__link icon-arrow-right"></a></li></menu></footer><script>(function(h,g,l,k,j,i){j=h.createElement(g),i=h.getElementsByTagName(g)[0],
j.src="//"+l+".disqus.com/"+k+".js",i.parentNode.insertBefore(j,i)})
(document,"script","yipinuu","embed");
</script></body></html>