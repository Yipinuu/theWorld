<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" content="是游悠品意的个人站点，现在主要是技术文章和个人作品发表"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="照东方万八千世界" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>使用Mina自动部署railsApp - 照东方万八千世界</title><link rel="stylesheet" href="/css/main.css" type="text/css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">照东方万八千世界</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li><li class="head-nav__item"><a href="http://Lofter.yipinuu.com" class="head-nav__link">Photo</a></li><li class="head-nav__item"><a href="/about.html" class="head-nav__link">About</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2015-09-05T16:00:00.000Z" class="post__time">九月 6, 2015</time><h1 class="post__title"><a href="/2015/使用Mina自动部署railsApp/">使用Mina自动部署railsApp</a></h1></header><div class="post__main echo"><h2 id="前言">前言</h2><p>之前在ruby-china里看了<a href="https://ruby-china.org/topics/26661" target="_blank" rel="external">Mina部署</a>的安利文章，就计划着，利用mina来部署一次。这个网站是根据rails 10日谈的教程来编写的。</p>
<h2 id="在本地配置mina">在本地配置mina</h2><p>首先安装 mina 以及 mina-sidekiq 和 mina-unicorn。</p>
<p>在Gemfile中添加：</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># Really fast deployer and server automation tool.</span></span><br><span class="line"><span class="preprocessor"># http://github.com/nadarei/mina</span></span><br><span class="line"><span class="preprocessor"># https://ruby-china.org/topics/26661</span></span><br><span class="line">gem <span class="string">'mina'</span>, <span class="string">'~&gt; 0.3.7'</span></span><br><span class="line"><span class="preprocessor"># https://github.com/Mic92/mina-sidekiq</span></span><br><span class="line">gem <span class="string">'mina-sidekiq'</span>,:require =&gt; <span class="literal">false</span></span><br><span class="line"><span class="preprocessor"># https://github.com/scarfacedeb/mina-unicorn</span></span><br><span class="line">gem <span class="string">'mina-unicorn'</span>, :require =&gt; <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>然后初始化mina：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mina init</span><br></pre></td></tr></table></figure></p>
<p>根据文章提示修改了deploy.rb文件<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'mina/bundler'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'mina/rails'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'mina/git'</span></span><br><span class="line"><span class="comment"># require 'mina/rbenv'  # for rbenv support. (http://rbenv.org)</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'mina/rvm'</span>    <span class="comment"># for rvm support. (http://rvm.io)</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'mina/unicorn'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">"mina_sidekiq/tasks"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Basic settings:</span></span><br><span class="line"><span class="comment">#   domain       - The hostname to SSH to.</span></span><br><span class="line"><span class="comment">#   deploy_to    - Path to deploy into.</span></span><br><span class="line"><span class="comment">#   repository   - Git repo to clone from. (needed by mina/git)</span></span><br><span class="line"><span class="comment">#   branch       - Branch name to deploy. (needed by mina/git)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置主机</span></span><br><span class="line">set <span class="symbol">:domain</span>, <span class="string">'173.255.247.223'</span></span><br><span class="line">set <span class="symbol">:deploy_to</span>, <span class="string">'/var/www/rails10'</span></span><br><span class="line"><span class="comment"># Optional settings:</span></span><br><span class="line"><span class="comment">#   set :user, 'foobar'    # Username in the server to SSH to.</span></span><br><span class="line"><span class="comment">#   set :port, '30000'     # SSH port number.</span></span><br><span class="line"><span class="comment">#   set :forward_agent, true     # SSH forward_agent.</span></span><br><span class="line">set <span class="symbol">:user</span>, <span class="string">'deployer'</span></span><br><span class="line">set <span class="symbol">:port</span>, <span class="string">'3118'</span></span><br><span class="line">set <span class="symbol">:forward_agent</span>, <span class="keyword">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置git</span></span><br><span class="line">set <span class="symbol">:repository</span>, <span class="string">'git://...'</span></span><br><span class="line">set <span class="symbol">:branch</span>, <span class="string">'master'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># For system-wide RVM install.</span></span><br><span class="line"><span class="comment">#   set :rvm_path, '/usr/local/rvm/bin/rvm'</span></span><br><span class="line">set <span class="symbol">:rbenv_path</span>, <span class="string">'/usr/local/rvm/bin/rvm'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置sidekiq的进程保存地址</span></span><br><span class="line">set <span class="symbol">:sidekiq_pid</span>, <span class="string">"<span class="subst">#&#123;deploy_to&#125;</span>/tmp/pids/sidekiq.pid"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置unicorn pid 及 进程的启动环境</span></span><br><span class="line">set <span class="symbol">:unicorn_pid</span>, <span class="string">"<span class="subst">#&#123;deploy_to&#125;</span>/tmp/pids/unicorn.pid"</span></span><br><span class="line">set <span class="symbol">:unicorn_env</span>, <span class="string">'production'</span></span><br><span class="line">task <span class="symbol">:environment</span> <span class="keyword">do</span></span><br><span class="line">  invoke <span class="symbol">:<span class="string">'rvm:use[ruby-2.0.0@default]'</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment"># This task is the environment that is loaded for most commands, such as</span></span><br><span class="line"><span class="comment"># `mina deploy` or `mina rake`.</span></span><br><span class="line"><span class="comment"># task :environment do</span></span><br><span class="line">  <span class="comment"># If you're using rbenv, use this to load the rbenv environment.</span></span><br><span class="line">  <span class="comment"># Be sure to commit your .ruby-version or .rbenv-version to your repository.</span></span><br><span class="line">  <span class="comment"># invoke :'rbenv:load'</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># For those using RVM, use this to load an RVM version<span class="doctag">@gemset</span>.</span></span><br><span class="line">  <span class="comment"># invoke :'rvm:use[ruby-1.9.3-p125<span class="doctag">@default</span>]'</span></span><br><span class="line"><span class="comment"># end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置共享文件或目录</span></span><br><span class="line"><span class="comment"># Manually create these paths in shared/ (eg: shared/config/database.yml) in your server.</span></span><br><span class="line"><span class="comment"># They will be linked in the 'deploy:link_shared_paths' step.</span></span><br><span class="line">set <span class="symbol">:shared_paths</span>, [<span class="string">'config/database.yml'</span>, <span class="string">'config/secrets.yml'</span>, <span class="string">'log'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置目标主机目录及文件 (mina setup)</span></span><br><span class="line"><span class="comment"># Put any custom mkdir's in here for when `mina setup` is ran.</span></span><br><span class="line"><span class="comment"># For Rails apps, we'll make some of the shared paths that are shared between</span></span><br><span class="line"><span class="comment"># all releases.</span></span><br><span class="line">task <span class="symbol">:setup</span> =&gt; <span class="symbol">:environment</span> <span class="keyword">do</span></span><br><span class="line">  <span class="comment"># unicorn and sidekiq needs a place to store its pid file</span></span><br><span class="line">  queue! <span class="string">%[mkdir -p "<span class="subst">#&#123;deploy_to&#125;</span>/tmp/sockets/"]</span></span><br><span class="line">  queue! <span class="string">%[mkdir -p "<span class="subst">#&#123;deploy_to&#125;</span>/tmp/pids/"]</span></span><br><span class="line"></span><br><span class="line">  queue! <span class="string">%[mkdir -p "<span class="subst">#&#123;deploy_to&#125;</span>/<span class="subst">#&#123;shared_path&#125;</span>/log"]</span></span><br><span class="line">  queue! <span class="string">%[mkdir -p "<span class="subst">#&#123;deploy_to&#125;</span>/<span class="subst">#&#123;shared_path&#125;</span>/config"]</span></span><br><span class="line"></span><br><span class="line">  queue! <span class="string">%[touch "<span class="subst">#&#123;deploy_to&#125;</span>/<span class="subst">#&#123;shared_path&#125;</span>/config/database.yml"]</span></span><br><span class="line">  queue! <span class="string">%[touch "<span class="subst">#&#123;deploy_to&#125;</span>/<span class="subst">#&#123;shared_path&#125;</span>/config/secrets.yml"]</span></span><br><span class="line">  queue  <span class="string">%[echo "-----&gt; Be sure to edit '<span class="subst">#&#123;deploy_to&#125;</span>/<span class="subst">#&#123;shared_path&#125;</span>/config/database.yml','secrets.yml'."]</span></span><br><span class="line"></span><br><span class="line">  queue <span class="string">%[</span><br><span class="line">    repo_host=`echo $repo | sed -e 's/.*@//g' -e 's/:.*//g'` &amp;&amp;</span><br><span class="line">    repo_port=`echo $repo | grep -o ':[0-9]</span>*<span class="string">' | sed -e '</span>s/<span class="symbol">://g<span class="string">'` &amp;&amp;</span><br><span class="line">    if [ -z "$&#123;repo_port&#125;" ]; then repo_port=22; fi ]</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># 增加部署命令(mina deploy)</span><br><span class="line">desc "Deploys the current version to the server."</span><br><span class="line">task :deploy =&gt; :environment do</span><br><span class="line">  to :before_hook do</span><br><span class="line">    # Put things to run locally before ssh</span><br><span class="line">  end</span><br><span class="line">  deploy do</span><br><span class="line">    # Put things that will set up an empty directory into a fully set-up</span><br><span class="line">    # instance of your project.</span><br><span class="line">    invoke :'</span>git</span><span class="symbol">:clone<span class="string">'</span><br><span class="line">    invoke :'</span>deploy</span><span class="symbol">:link_shared_paths<span class="string">'</span><br><span class="line">    invoke :'</span>bundle</span><span class="symbol">:install<span class="string">'</span><br><span class="line">    invoke :'</span>rails</span><span class="symbol">:db_migrate<span class="string">'</span><br><span class="line">    invoke :'</span>rails</span><span class="symbol">:assets_precompile<span class="string">'</span><br><span class="line">    invoke :'</span>deploy</span><span class="symbol">:cleanup<span class="string">'</span><br><span class="line"></span><br><span class="line">    # to :launch do</span><br><span class="line">    #   queue "mkdir -p <span class="subst">#&#123;deploy_to&#125;</span>/<span class="subst">#&#123;current_path&#125;</span>/tmp/"</span><br><span class="line">    #   queue "touch <span class="subst">#&#123;deploy_to&#125;</span>/<span class="subst">#&#123;current_path&#125;</span>/tmp/restart.txt"</span><br><span class="line">    # end</span><br><span class="line"></span><br><span class="line">    # task:deploy，首先从repository的branch中clone一份代码到deploy_to目录，</span><br><span class="line">    # 然后生成连接目录及文件，执行bundle, db_migrate,assets_precompile命令，</span><br><span class="line">    # 最后会执行launch，里面的sidekiq 异步任务的重启，以及unicorn进程重启。</span><br><span class="line">    to :launch do</span><br><span class="line">      # sidekiq stop accepting new workers</span><br><span class="line">      invoke :'</span>sidekiq</span><span class="symbol">:quiet<span class="string">'</span><br><span class="line">      invoke :'</span>sidekiq</span><span class="symbol">:restart<span class="string">'</span><br><span class="line">      invoke :'</span>unicorn</span><span class="symbol">:restart<span class="string">'</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># For help in making your deploy script, see the Mina documentation:</span><br><span class="line">#</span><br><span class="line">#  - http://nadarei.co/mina</span><br><span class="line">#  - http://nadarei.co/mina/tasks</span><br><span class="line">#  - http://nadarei.co/mina/settings</span><br><span class="line">#  - http://nadarei.co/mina/helpers</span></span></span><br></pre></td></tr></table></figure></p>
<h2 id="服务器设置">服务器设置</h2><p>按照自己的情况，该略过的略过吧。</p>
<p>设置deploy账号<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ adduser deploy --ingroup sudo</span><br></pre></td></tr></table></figure></p>
<p>安装mysql<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install mysql-server mysql-client libmysqlclient-dev</span><br></pre></td></tr></table></figure></p>
<p>安装rvm<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://raw.githubusercontent.com/rvm/rvm/master/binscripts/rvm-installer | bash <span class="operator">-s</span> stable</span><br></pre></td></tr></table></figure></p>
<p>设置SSH<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~<span class="regexp">/.ssh/authorized</span>_keys</span><br></pre></td></tr></table></figure></p>
<p>赋予deploy账号权限<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="keyword">mkdir</span> -p <span class="string">"/var/www/rails10"</span> &amp;&amp; sudo <span class="keyword">chown</span> -R deploy <span class="string">"/var/www/rails10"</span></span><br></pre></td></tr></table></figure></p>
<p>TBC.</p>
</div><footer class="post__foot u-cf"><a href="/2015/使用Mina自动部署railsApp/#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article><div class="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript></div></div></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2015 游悠品意</div><menu class="page-menu u-fr"><li class="page-menu__item"><a title="Previous" href="/2015/devise实践笔记/" class="page-menu__link icon-arrow-left"></a></li><li class="page-menu__item"><a title="Next" href="/2015/如何在一个电脑上同时使用两个git的账号/" class="page-menu__link icon-arrow-right"></a></li></menu></footer><script>(function(h,g,l,k,j,i){j=h.createElement(g),i=h.getElementsByTagName(g)[0],
j.src="//"+l+".disqus.com/"+k+".js",i.parentNode.insertBefore(j,i)})
(document,"script","yipinuu","embed");
</script></body></html>