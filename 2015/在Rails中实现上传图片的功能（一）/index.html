<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" content="是游悠品意的个人站点，现在主要是技术文章和个人作品发表"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="照东方万八千世界" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>在Rails中实现上传图片的功能（一）:多张图片的上传以及单张删除 - 照东方万八千世界</title><link rel="stylesheet" href="/css/main.css" type="text/css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">照东方万八千世界</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li><li class="head-nav__item"><a href="http://Lofter.yipinuu.com" class="head-nav__link">Photo</a></li><li class="head-nav__item"><a href="/about.html" class="head-nav__link">About</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2015-09-11T16:00:00.000Z" class="post__time">九月 12, 2015</time><h1 class="post__title"><a href="/2015/在Rails中实现上传图片的功能（一）/">在Rails中实现上传图片的功能（一）:多张图片的上传以及单张删除</a></h1></header><div class="post__main echo"><h2 id="前言">前言</h2><p>新任务是实现上传图片的功能。<br>首先我实现了上传多张图片，删除单张图片，最后优化了代码，实现使用AJAX上传图片。<br>使用的gem有：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Upload files in your Ruby applications,</span></span><br><span class="line"><span class="comment"># map them to a range of ORMs, store them on different backends.</span></span><br><span class="line"><span class="comment"># https://github.com/carrierwaveuploader/carrierwave</span></span><br><span class="line">gem <span class="string">'carrierwave'</span>, <span class="string">'~&gt;0.10.0'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Rails jQuery file uploads via standard Rails "remote: true" forms.</span></span><br><span class="line"><span class="comment"># https://github.com/JangoSteve/remotipart</span></span><br><span class="line">gem <span class="string">'remotipart'</span>, <span class="string">'~&gt; 1.2'</span></span><br></pre></td></tr></table></figure>
<h2 id="配置routes">配置routes</h2><p>首先配置routes.rb</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">resources <span class="symbol">:images</span>, <span class="symbol">only:</span> <span class="symbol">:destroy</span></span><br><span class="line">resources <span class="symbol">:projects</span> <span class="keyword">do</span></span><br><span class="line">  post <span class="string">'upload_images'</span>, <span class="symbol">on:</span> <span class="symbol">:member</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">post</span> upload_images_admin_project_path</span><br><span class="line"><span class="built_in">delete</span> admin_image_path</span><br></pre></td></tr></table></figure>
<h2 id="上传多张图片">上传多张图片</h2><p>接下来，我要实现上传多张图片的功能。routes 已经在上一步配置好了， 现在去设置 controller。<br>上传单张图片我们使用的是 ProjectsController ，因为图片是存在于Projects里的，所以放在 ProjectController 中去处理。而删除图片的 url 是需要带有 image 的 ID 的，使用 ProjectsController 并不便利。 所以单独出来，使用 ImagesController 处理。</p>
<p>普通的 file_filed 是不具有上传多张图片的功能的。为 file_filed 加入了 <code>multiple: true</code>，它是的我们表单拥有同时上传多文件的功能。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">%=</span> <span class="attribute">file_field</span> <span class="attribute">:landscapes</span>, <span class="attribute">:uploaded_image</span>, <span class="attribute">multiple:</span> <span class="attribute">true</span> %&gt;</span></span><br></pre></td></tr></table></figure>
<p>这是处理表单的逻辑部分的代码：<br>_landscaps.html.erb<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">%=</span> <span class="attribute">form_for</span> <span class="attribute">:landscapes</span>, <span class="attribute">url:</span> <span class="attribute">upload_images_admin_project_path</span>,</span><br><span class="line">                          <span class="attribute">html:</span> &#123; <span class="attribute">class:</span> "<span class="attribute">col-md-12</span>" &#125;,</span><br><span class="line">                          <span class="attribute">remote:</span> <span class="attribute">true</span> <span class="attribute">do</span> | <span class="attribute">landscape</span> | %&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">%=</span> <span class="attribute">landscapes.hidden_field_tag</span> "<span class="attribute">project_id</span>", "#&#123;@<span class="attribute">project.id</span>&#125;" %&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">%=</span> <span class="attribute">landscapes.file_field</span> <span class="attribute">:upload_image</span>, <span class="attribute">mulitple:</span> <span class="attribute">true</span>, <span class="attribute">class:</span> "<span class="attribute">col-md-7</span>" %&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">%=</span> <span class="attribute">landscapes.submit</span> "<span class="attribute">Upload</span> <span class="attribute">landscapes</span>", <span class="attribute">class</span>=<span class="value">"btn btn-xs col-md-5"</span> %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">%</span> <span class="attribute">end</span> %&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>我需要project_id，所有在这里有传递了它。<br>我们有了 routes 有了 view，现在只剩下了 controller 就可以解决多张图片的上传问题了。<br>现在，我们需要知道它会通过 params 传递了什么数据 给我们的controller。<br>在 action 中设置 <code>binding.pry</code> 。我们就可以在 rails server 里面输入params 从而知道我们怎么拿数据了。</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"landscape"</span>=&gt;</span><br><span class="line"> &#123;<span class="string">"uploaded_image"</span>=&gt;</span><br><span class="line">   [<span class="preprocessor">#&lt;ActionDispatch::Http::UploadedFile:0x007fd16aa09810</span></span><br><span class="line">     <span class="constant">@content_type</span>=<span class="string">"image/png"</span>,</span><br><span class="line">     <span class="constant">@headers</span>=<span class="string">"Content-Disposition: form-data; name=\"</span>landscape[uploaded_image][]\<span class="string">"; filename=\"</span>\xE5\x86\x85\xE5\xAE\xB9.png\<span class="string">"\r\nContent-Type: image/png\r\n"</span>,</span><br><span class="line">     <span class="constant">@original_filename</span>=<span class="string">"image1.png"</span>,</span><br><span class="line">     <span class="constant">@tempfile</span>=<span class="preprocessor">#&lt;File:/var/folders/5l/xst3vkjn331gsb_qmb2yt8_r0000gn/T/RackMultipart20150909-31808-1pws53y.png&gt;&gt;,</span></span><br><span class="line">    <span class="preprocessor">#&lt;ActionDispatch::Http::UploadedFile:0x007fd16aa0a1e8</span></span><br><span class="line">     <span class="constant">@content_type</span>=<span class="string">"image/png"</span>,</span><br><span class="line">     <span class="constant">@headers</span>=<span class="string">"Content-Disposition: form-data; name=\"</span>landscape[uploaded_image][]\<span class="string">"; filename=\"</span>image2.png\<span class="string">"\r\nContent-Type: image/png\r\n"</span>,</span><br><span class="line">     <span class="constant">@original_filename</span>=<span class="string">"Create_a_New_Repository.png"</span>,</span><br><span class="line">     <span class="constant">@tempfile</span>=<span class="preprocessor">#&lt;File:/var/folders/5l/xst3vkjn331gsb_qmb2yt8_r0000gn/T/RackMultipart20150909-31808-2nnxge.png&gt;&gt;]&#125;,</span></span><br></pre></td></tr></table></figure>
<p>那么使用 <code>params[:landscape][:uploaded_image]</code> 就可以拿到一个数组。<br>我使用了 each 去遍历它。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_image</span></span></span><br><span class="line">  respond_to <span class="keyword">do</span> |format|</span><br><span class="line">    <span class="keyword">if</span> params[<span class="symbol">:landscape</span>]</span><br><span class="line">      params[<span class="symbol">:landscape</span>][<span class="symbol">:uploaded_image</span>].each <span class="keyword">do</span> |image|</span><br><span class="line">        landscape_image = <span class="variable">@project</span>.landscapes.create(<span class="symbol">uploaded_image:</span> image)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      format.js</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    format.json &#123; render <span class="symbol">json:</span> &#123; <span class="symbol">project:</span> <span class="variable">@project</span> &#125; &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>然后我们就可以发现，现在已经可以上传单张图片了。</p>
<h2 id="删除图片">删除图片</h2><p>接下来我们要实现的是删除功能。<br>当然，这个很简单的，可以忽略不看。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 下面的代码是将project下的所有的landcape都拿出来并一一显示了,还有删除的小图标。 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">%</span> @<span class="attribute">project.landscapes.each</span> <span class="attribute">do</span> |<span class="attribute">landscape</span>| %&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">%=</span> <span class="attribute">image_tag</span> <span class="attribute">landscape.uploaded_image</span> %&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">%=</span> <span class="attribute">link_to</span> <span class="attribute">admin_image_path</span>(<span class="attribute">landscape.id</span>), <span class="attribute">method:</span> <span class="attribute">:delete</span>, <span class="attribute">data:</span> &#123; <span class="attribute">confirm:</span> "<span class="attribute">Do</span> <span class="attribute">you</span> <span class="attribute">want</span> <span class="attribute">destory</span> <span class="attribute">this</span> <span class="attribute">project</span>"&#125;  <span class="attribute">do</span> %&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="title">i</span> <span class="attribute">class</span>=<span class="value">"fa fa-trash"</span>&gt;</span><span class="tag">&lt;/<span class="title">i</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">%</span> <span class="attribute">end</span> %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">%</span> <span class="attribute">end</span> %&gt;</span></span><br></pre></td></tr></table></figure>
<p>destory 的 controller 我选择了新建了 ImagesController 。<br>因为 destory 带有 id，使用 ProjectsController 很别扭。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Admin::ImagesController</span> <span class="inheritance">&lt; <span class="parent">Admin::BaseController</span></span></span></span><br><span class="line">  before_action <span class="symbol">:set_image</span>, <span class="symbol">only:</span> <span class="symbol">:destroy</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">destroy</span></span></span><br><span class="line">    respond_to <span class="keyword">do</span> |format|</span><br><span class="line">      <span class="keyword">if</span> <span class="variable">@image</span>.destroy</span><br><span class="line">        format.html &#123;redirect_to edit_admin_project_path(<span class="symbol">id:</span> <span class="variable">@image</span>.project_id)&#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        format.html &#123;redirect_to <span class="symbol">:back</span>, <span class="symbol">notice:</span> <span class="string">"You can't delete this image"</span>&#125;</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  private</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_image</span></span></span><br><span class="line">      <span class="variable">@image</span> = <span class="constant">Image</span>.find(params[<span class="symbol">:id</span>])</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这样，我们的删除图片功能也实现了。</p>
</div><footer class="post__foot u-cf"><a href="/2015/在Rails中实现上传图片的功能（一）/#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article><div class="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript></div></div></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2015 游悠品意</div><menu class="page-menu u-fr"><li class="page-menu__item"><a title="Previous" href="/2015/MAC上使用Go/" class="page-menu__link icon-arrow-left"></a></li><li class="page-menu__item"><a title="Next" href="/2015/在rails中实现分布提交表单/" class="page-menu__link icon-arrow-right"></a></li></menu></footer><script>(function(h,g,l,k,j,i){j=h.createElement(g),i=h.getElementsByTagName(g)[0],
j.src="//"+l+".disqus.com/"+k+".js",i.parentNode.insertBefore(j,i)})
(document,"script","yipinuu","embed");
</script></body></html>