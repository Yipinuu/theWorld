<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" content="是游悠品意的个人站点，现在主要是技术文章和个人作品发表"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="照东方万八千世界" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>《Rails 实践》简略笔记 - 照东方万八千世界</title><link rel="stylesheet" href="/css/main.css" type="text/css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">照东方万八千世界</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li><li class="head-nav__item"><a href="http://Lofter.yipinuu.com" class="head-nav__link">Photo</a></li><li class="head-nav__item"><a href="/about.html" class="head-nav__link">About</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2015-09-20T13:20:47.000Z" class="post__time">九月 20, 2015</time><h1 class="post__title"><a href="/project/Rails/《Rails 实践》简略笔记.html">《Rails 实践》简略笔记</a></h1></header><div class="post__main echo"><h2 id="前言">前言</h2><p>Rails 实践是前段时间发现的一个挺不错的入门教材，于是打算花点时间来阅读和练习一下。<br>与Rails 基础有关的笔记写的挺多了，在这里只会写一些我觉得必要的。</p>
<p>这里主要写了快速创建界面、常用的helper方法、RSS和ATOM</p>
<h3 id="用户界面">用户界面</h3><p>Gemfile<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gem <span class="string">"therubyracer"</span></span><br><span class="line">gem <span class="string">"less-rails"</span></span><br><span class="line">gem <span class="string">"twitter-bootstrap-rails"</span></span><br><span class="line">gem <span class="string">'twitter-bootswatch-rails'</span></span><br><span class="line">gem <span class="string">'twitter-bootswatch-rails-helpers'</span></span><br></pre></td></tr></table></figure></p>
<p>命令<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># 创建 product 资源</span></span><br><span class="line">rails g scaffold product name price:decimal description:text</span><br><span class="line"><span class="preprocessor"># 更新 db 解构</span></span><br><span class="line">rake db:migrate</span><br><span class="line"><span class="preprocessor"># 安装 bootstrap 文件</span></span><br><span class="line">rails generate bootstrap:install</span><br><span class="line"><span class="preprocessor"># 创建一个 layout</span></span><br><span class="line">rails g bootstrap:layout</span><br><span class="line"><span class="preprocessor"># 创建资源模板</span></span><br><span class="line">rails g bootstrap:themed Products</span><br><span class="line"><span class="preprocessor"># 安装该 theme 的基础文件</span></span><br><span class="line">rails g bootswatch:install cerulean</span><br><span class="line"><span class="preprocessor"># 导入一个线上的 theme 的变量文件</span></span><br><span class="line">rails g bootswatch:import cerulean</span><br></pre></td></tr></table></figure></p>
<p>application.css<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*= <span class="preprocessor">require</span> cerulean/loader</span><br><span class="line">*= <span class="preprocessor">require</span> cerulean/<span class="keyword">bootswatch</span></span><br></pre></td></tr></table></figure></p>
<p>仅仅这么几句话代码，就会可以拥有如此界面的 web 网站。</p>
<h2 id="Rails_中的资源">Rails 中的资源</h2><p>application.rb<br><figure class="highlight cal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">config.generators <span class="keyword">do</span> |cfg|</span><br><span class="line">  cfg.stylesheets     <span class="literal">false</span></span><br><span class="line">  cfg.javascripts     <span class="literal">false</span></span><br><span class="line">  cfg.helpers         <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>命令<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># <span class="tag">Convert</span> <span class="tag">Sass</span> <span class="tag">to</span> <span class="tag">SCSS</span></span><br><span class="line">% <span class="tag">sass-convert</span> <span class="tag">style</span><span class="class">.sass</span> <span class="tag">style</span><span class="class">.scss</span></span><br><span class="line"># <span class="tag">Convert</span> <span class="tag">SCSS</span> <span class="tag">to</span> <span class="tag">Sass</span></span><br><span class="line">% <span class="tag">sass-convert</span> <span class="tag">style</span><span class="class">.scss</span> <span class="tag">style</span><span class="class">.sass</span></span><br></pre></td></tr></table></figure></p>
<p>sass 示范<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 第一种，直接粘贴图片地址，比如</span><br><span class="line"><span class="rule"><span class="attribute">background-image</span>:<span class="value"> <span class="function">url</span>(<span class="string">"/assets/logo.png"</span>)</span></span>;</span><br><span class="line"># 它不能使用 <span class="tag">digest</span> 方式来使用图片资源，也不够灵活</span><br><span class="line"># 第二种，将图片文件放到 <span class="tag">public</span> 下，比如</span><br><span class="line"><span class="rule"><span class="attribute">background-image</span>:<span class="value"> <span class="function">url</span>(<span class="string">"/images/logo.png"</span>)</span></span>;</span><br><span class="line"># 需要我们在 <span class="tag">public</span> 下建立一个 <span class="tag">images</span> 文件夹来管理图片文件，也不能使用 <span class="tag">digest</span></span><br><span class="line"># 第三种，直接使用 <span class="tag">sass-rails</span> 提供的辅助方法</span><br><span class="line"><span class="rule"><span class="attribute">background-image</span>:<span class="value"> <span class="function">asset-url</span>(<span class="string">'logo.png'</span>)</span></span>;</span><br><span class="line"># 第四种方法，使用 <span class="tag">erb</span> 来重构 <span class="tag">sass</span>，文件可能是这样的，<span class="tag">style</span><span class="class">.css</span><span class="class">.scss</span><span class="class">.erb</span>，这样就可以在 <span class="tag">scss</span> 里插入 <span class="tag">erb</span> 的语法</span><br><span class="line"><span class="rule"><span class="attribute">background-image</span>:<span class="value"> <span class="function">url</span>(&lt;%= asset_path <span class="string">'logo.png'</span> %&gt;)</span></span>;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>Rails 对资源的定义</p>
<ol>
<li>直接简短的资源地址： URL</li>
<li>可传输的资源：Web 服务接受与返回的互联网媒体类型，JSON、XML、YAML等。</li>
<li>对资源的操作：Web 服务在该资源上所支持的一系列请求方法（POST GET PUT 等）</li>
</ol>
</blockquote>
<p>routes.rb<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># concern 定义好的资源，可以被其他 resource 里多次引用。</span></span><br><span class="line">concern <span class="symbol">:commentable</span> <span class="keyword">do</span></span><br><span class="line">  resources <span class="symbol">:comments</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">concern <span class="symbol">:image_attachable</span> <span class="keyword">do</span></span><br><span class="line">  resources <span class="symbol">:images</span>, <span class="symbol">only:</span> <span class="symbol">:index</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">resources <span class="symbol">:messages</span>, <span class="symbol">concerns:</span> <span class="symbol">:commentable</span></span><br><span class="line">resources <span class="symbol">:articles</span>, <span class="symbol">concerns:</span> [<span class="symbol">:commentable</span>, <span class="symbol">:image_attachable</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 它把 index、new 和 create 方法保留在了 products/:id 这个资源下，而把其他方法，重新放回到 /comments 下。这样的考虑是避免过多的实用嵌套 routes，并且让代码更简洁。</span></span><br><span class="line">resources <span class="symbol">:products</span> <span class="keyword">do</span></span><br><span class="line">  resources <span class="symbol">:comments</span>, <span class="symbol">shallow:</span> <span class="keyword">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这时，id 为 A 到 Z 开头，且后面为5位数字的 id，才符合路由条件，转入到 show 方法。而 products/A123456 将会提示 No route matches</span></span><br><span class="line">get <span class="string">'photos/:id'</span>, <span class="symbol">to:</span> <span class="string">'photos#show'</span>, <span class="symbol">constraints:</span> &#123; <span class="symbol">id:</span> /[<span class="constant">A</span>-<span class="constant">Z</span>]\d&#123;<span class="number">5</span>&#125;/ &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Rails_中的视图">Rails 中的视图</h2><p>在head中添加<br>application.html.erb<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">%=</span> <span class="attribute">yield</span>(<span class="attribute">:page_stylesheet</span>) <span class="attribute">if</span> <span class="attribute">content_for</span>?(<span class="attribute">:page_stylesheet</span>) %&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">head</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>index.html.erb<br><figure class="highlight erb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span>&lt;%=<span class="ruby"> content_for <span class="symbol">:page_stylesheet</span> <span class="keyword">do</span> </span>%&gt;<span class="xml"></span><br><span class="line"><span class="comment">&lt;!-- 这是 index.html.erb 里单独使用的 --&gt;</span></span><br><span class="line"></span>&lt;%<span class="ruby"> <span class="keyword">end</span> </span>%&gt;<span class="xml"></span></span><br></pre></td></tr></table></figure></p>
<h3 id="更改布局">更改布局</h3><p>情形一：admin 要使用自己的布局文件 app/views/layouts/admin.html.erb<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdminController</span> <span class="inheritance">&lt; <span class="parent">ApplicationController</span></span></span></span><br><span class="line">  layout <span class="string">"admin"</span></span><br><span class="line">  ...</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>情形二：为完成某个特殊操作，我们需要更改布局。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span></span></span><br><span class="line">  <span class="variable">@product</span> = <span class="constant">Product</span>.new</span><br><span class="line">  render <span class="symbol">layout:</span> <span class="string">"another_layout"</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>情形三：不用布局<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span></span></span><br><span class="line">  render <span class="symbol">layout:</span> <span class="keyword">false</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Helper">Helper</h3><p>link_to<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= link_to <span class="string">"删除"</span>, product, <span class="symbol">:method</span> =&gt; <span class="symbol">:delete</span>, <span class="symbol">:data</span> =&gt; &#123; <span class="symbol">:confirm</span> =&gt; <span class="string">"点击确定继续"</span> &#125;, <span class="symbol">:class</span> =&gt; <span class="string">'btn btn-danger btn-xs'</span> %&gt;</span><br></pre></td></tr></table></figure></p>
<p>PS. Rails 使用 sprockets-rails 来管理 app/assets 中的文件</p>
<p>auto_discovery_link_tag<br><figure class="highlight erb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="title">head</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"></span>&lt;%=<span class="ruby"> auto_discovery_link_tag(<span class="symbol">:rss</span>, &#123;<span class="symbol">controller:</span> <span class="string">"products"</span>, <span class="symbol">action:</span> <span class="string">"index"</span>&#125;, &#123;<span class="symbol">title:</span> <span class="string">"RSS Feed"</span>&#125;) </span>%&gt;<span class="xml"></span><br><span class="line"></span>&lt;%=<span class="ruby"> auto_discovery_link_tag(<span class="symbol">:atom</span>, &#123;<span class="symbol">controller:</span> <span class="string">"products"</span>, <span class="symbol">action:</span> <span class="string">"index"</span>&#125;, &#123;<span class="symbol">title:</span> <span class="string">"ATOM Feed"</span>&#125;) </span>%&gt;<span class="xml"></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;/<span class="title">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"># 也可以在页面中加载</span><br><span class="line"></span>&lt;%=<span class="ruby"> link_to <span class="string">"rss"</span>, products_url(<span class="symbol">format:</span> <span class="string">"rss"</span>) </span>%&gt;<span class="xml"></span><br><span class="line"></span>&lt;%=<span class="ruby"> link_to <span class="string">"atom"</span>, products_url(<span class="symbol">format:</span> <span class="string">"atom"</span>) </span>%&gt;<span class="xml"></span></span><br></pre></td></tr></table></figure></p>
<p>app/controllers/products_controller.rb<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">respond_to <span class="keyword">do</span> |<span class="keyword">format</span>|</span><br><span class="line">  <span class="keyword">format</span>.html</span><br><span class="line">  <span class="keyword">format</span>.rss &#123; ... &#125;</span><br><span class="line">  <span class="keyword">format</span>.atom &#123; ... &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>app/views/products/index.atom.builder<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">atom_feed <span class="keyword">do</span> |feed|</span><br><span class="line">  feed.title <span class="string">"商品列表"</span></span><br><span class="line">  feed.updated <span class="variable">@products</span>.maximum(<span class="symbol">:updated_at</span>)</span><br><span class="line"></span><br><span class="line">  <span class="variable">@products</span>.each <span class="keyword">do</span> |product|</span><br><span class="line">    feed.entry product, <span class="symbol">published:</span> product.updated_at <span class="keyword">do</span> |entry|</span><br><span class="line">      entry.title product.name</span><br><span class="line">      entry.content product.description</span><br><span class="line">      entry.price product.price</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>app/views/products/index.rss.builder<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">xml.instruct! <span class="symbol">:xml</span>, <span class="symbol">version:</span> <span class="string">"1.0"</span></span><br><span class="line">xml.rss <span class="symbol">version:</span> <span class="string">"2.0"</span> <span class="keyword">do</span></span><br><span class="line">  xml.channel <span class="keyword">do</span></span><br><span class="line">    xml.title <span class="string">"商品列表"</span></span><br><span class="line">    xml.description <span class="string">"这是商品列表"</span></span><br><span class="line">    xml.link products_url</span><br><span class="line"></span><br><span class="line">    <span class="variable">@products</span>.each <span class="keyword">do</span> |product|</span><br><span class="line">      xml.item <span class="keyword">do</span></span><br><span class="line">        xml.title product.name</span><br><span class="line">        xml.description product.description</span><br><span class="line">        xml.price product.price</span><br><span class="line">        xml.link product_url(product)</span><br><span class="line">        xml.guid product_url(product)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>我们用到了 .builder 这个结尾的文件。它会告诉 Rails 使用 Builder::XmlMarkup 这个库（lib）来解析文件。<br>所以看 rss.builder，它是按照 xml 格式写的。<br>atom.builder 用到了另一个辅助方法 atom_feed，写法虽然不同，但是生成的内容也是 xml 格式的。</p>
<p>在 scaffold 创建的文件里，你会看到 index.json.jbuilder。<br>它会使用 JBuilder 这个库来解析并生成 json 的结果。</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;% <span class="variable">@products</span>.each <span class="keyword">do</span> |product| <span class="variable">%&gt;</span></span><br><span class="line">  &lt;<span class="variable">%=</span> <span class="keyword">render</span> partial: <span class="string">"product"</span>, locals: &#123; product: product &#125; <span class="variable">%&gt;</span></span><br><span class="line">&lt;% end <span class="variable">%&gt;</span></span><br><span class="line"># 两者等价</span><br><span class="line">&lt;<span class="variable">%=</span> <span class="keyword">render</span> <span class="variable">@products</span> <span class="variable">%&gt;</span></span><br></pre></td></tr></table></figure>
<p>Form 搜索表单<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= form_tag(products_path, <span class="keyword">method</span>: <span class="string">"get"</span>) <span class="keyword">do</span> %&gt;</span><br><span class="line">  &lt;%= label_tag(:q) %&gt;</span><br><span class="line">  &lt;%= text_field_tag(:q) %&gt;</span><br><span class="line">  &lt;%= submit_tag(<span class="string">"搜索"</span>) %&gt;</span><br><span class="line">&lt;% <span class="keyword">end</span> %&gt;</span><br></pre></td></tr></table></figure></p>
<p>我们可以在 controller 里，使用 ActiveRecord 的 where 方法查询传入的参数。<br>我们也可以使用 (ransack)[<a href="https://github.com/activerecord-hackery/ransack" target="_blank" rel="external">https://github.com/activerecord-hackery/ransack</a>] 这种 gem 来实现搜索功能。<br>:) ransack 的实践笔记以后会写。</p>
<h3 id="常用的表单辅助方法">常用的表单辅助方法</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= text_area_tag(<span class="symbol">:message</span>, <span class="string">"Hi, nice site"</span>, <span class="symbol">size:</span> <span class="string">"24x6"</span>) %&gt;</span><br><span class="line">&lt;%= password_field_tag(<span class="symbol">:password</span>) %&gt;</span><br><span class="line">&lt;%= hidden_field_tag(<span class="symbol">:parent_id</span>, <span class="string">"5"</span>) %&gt;</span><br><span class="line">&lt;%= search_field(<span class="symbol">:user</span>, <span class="symbol">:name</span>) %&gt;</span><br><span class="line">&lt;%= telephone_field(<span class="symbol">:user</span>, <span class="symbol">:phone</span>) %&gt;</span><br><span class="line">&lt;%= date_field(<span class="symbol">:user</span>, <span class="symbol">:born_on</span>) %&gt;</span><br><span class="line">&lt;%= datetime_field(<span class="symbol">:user</span>, <span class="symbol">:meeting_time</span>) %&gt;</span><br><span class="line">&lt;%= datetime_local_field(<span class="symbol">:user</span>, <span class="symbol">:graduation_day</span>) %&gt;</span><br><span class="line">&lt;%= month_field(<span class="symbol">:user</span>, <span class="symbol">:birthday_month</span>) %&gt;</span><br><span class="line">&lt;%= week_field(<span class="symbol">:user</span>, <span class="symbol">:birthday_week</span>) %&gt;</span><br><span class="line">&lt;%= url_field(<span class="symbol">:user</span>, <span class="symbol">:homepage</span>) %&gt;</span><br><span class="line">&lt;%= email_field(<span class="symbol">:user</span>, <span class="symbol">:address</span>) %&gt;</span><br><span class="line">&lt;%= color_field(<span class="symbol">:user</span>, <span class="symbol">:favorite_color</span>) %&gt;</span><br><span class="line">&lt;%= time_field(<span class="symbol">:task</span>, <span class="symbol">:started_at</span>) %&gt;</span><br><span class="line">&lt;%= number_field(<span class="symbol">:product</span>, <span class="symbol">:price</span>, <span class="symbol">in:</span> <span class="number">1.0</span>..<span class="number">20.0</span>, <span class="symbol">step:</span> <span class="number">0</span>.<span class="number">5</span>) %&gt;</span><br><span class="line">&lt;%= range_field(<span class="symbol">:product</span>, <span class="symbol">:discount</span>, <span class="symbol">in:</span> <span class="number">1</span>..<span class="number">100</span>) %&gt;</span><br></pre></td></tr></table></figure>
<p>解析后<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">textarea</span> <span class="attribute">id</span>=<span class="value">"message"</span> <span class="attribute">name</span>=<span class="value">"message"</span> <span class="attribute">cols</span>=<span class="value">"24"</span> <span class="attribute">rows</span>=<span class="value">"6"</span>&gt;</span>Hi, nice site<span class="tag">&lt;/<span class="title">textarea</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"password"</span> <span class="attribute">name</span>=<span class="value">"password"</span> <span class="attribute">type</span>=<span class="value">"password"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"parent_id"</span> <span class="attribute">name</span>=<span class="value">"parent_id"</span> <span class="attribute">type</span>=<span class="value">"hidden"</span> <span class="attribute">value</span>=<span class="value">"5"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"user_name"</span> <span class="attribute">name</span>=<span class="value">"user[name]"</span> <span class="attribute">type</span>=<span class="value">"search"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"user_phone"</span> <span class="attribute">name</span>=<span class="value">"user[phone]"</span> <span class="attribute">type</span>=<span class="value">"tel"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"user_born_on"</span> <span class="attribute">name</span>=<span class="value">"user[born_on]"</span> <span class="attribute">type</span>=<span class="value">"date"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"user_meeting_time"</span> <span class="attribute">name</span>=<span class="value">"user[meeting_time]"</span> <span class="attribute">type</span>=<span class="value">"datetime"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"user_graduation_day"</span> <span class="attribute">name</span>=<span class="value">"user[graduation_day]"</span> <span class="attribute">type</span>=<span class="value">"datetime-local"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"user_birthday_month"</span> <span class="attribute">name</span>=<span class="value">"user[birthday_month]"</span> <span class="attribute">type</span>=<span class="value">"month"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"user_birthday_week"</span> <span class="attribute">name</span>=<span class="value">"user[birthday_week]"</span> <span class="attribute">type</span>=<span class="value">"week"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"user_homepage"</span> <span class="attribute">name</span>=<span class="value">"user[homepage]"</span> <span class="attribute">type</span>=<span class="value">"url"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"user_address"</span> <span class="attribute">name</span>=<span class="value">"user[address]"</span> <span class="attribute">type</span>=<span class="value">"email"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"user_favorite_color"</span> <span class="attribute">name</span>=<span class="value">"user[favorite_color]"</span> <span class="attribute">type</span>=<span class="value">"color"</span> <span class="attribute">value</span>=<span class="value">"#000000"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"task_started_at"</span> <span class="attribute">name</span>=<span class="value">"task[started_at]"</span> <span class="attribute">type</span>=<span class="value">"time"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"product_price"</span> <span class="attribute">max</span>=<span class="value">"20.0"</span> <span class="attribute">min</span>=<span class="value">"1.0"</span> <span class="attribute">name</span>=<span class="value">"product[price]"</span> <span class="attribute">step</span>=<span class="value">"0.5"</span> <span class="attribute">type</span>=<span class="value">"number"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"product_discount"</span> <span class="attribute">max</span>=<span class="value">"100"</span> <span class="attribute">min</span>=<span class="value">"1"</span> <span class="attribute">name</span>=<span class="value">"product[discount]"</span> <span class="attribute">type</span>=<span class="value">"range"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>至于 devise的使用 已经有了 <a href="http://world.yipinuu.com/2015/09/devise%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/">实践笔记</a></p>
<h3 id="json_数据的页面处理">json 数据的页面处理</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">%=</span> <span class="attribute">link_to</span> <span class="attribute">t</span>('<span class="attribute">.edit</span>', <span class="attribute">:default</span> =&gt;</span> t("helpers.links.edit")), edit_product_path(product), remote: true, data: &#123; type: 'json' &#125;, :class =&gt; 'btn btn-primary btn-xs editProductLink' %&gt;</span><br></pre></td></tr></table></figure>
<p><a href="附表一.html">附表一</a></p>
<p>附表二：ajax 的回调方法，我们使用了 :success 和 :error，当然还有其他的一些，我们需要了解下。</p>
<p>| – | – | – |<br>|event name  |extra parameters <em> | when|<br>|ajax:before ||  before the whole ajax business , aborts if stopped|<br>|ajax:beforeSend | [event, xhr, settings] |  before the request is sent, aborts if stopped|<br>|ajax:send | [xhr] | when the request is sent |<br>|ajax:success | [data, status, xhr] | after completion, if the HTTP response was a success|<br>|ajax:error | [xhr, status, error] | after completion, if the server returned an error *</em>|<br>|ajax:complete | [xhr, status] | after the request has been completed, no matter what outcome|<br>|ajax:aborted:required | [elements] | when there are blank required fields in a form, submits anyway if stopped|<br>|ajax:aborted:file | [elements] | if there are non-blank input:file fields in a form, aborts if stopped|<br>| – | – | – |</p>
<p>完整的 HAML 示例<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="doctype">!!!</span></span><br><span class="line"><span class="tag">%<span class="title">html</span>&#123;html_attrs&#125;</span></span><br><span class="line"><span class="tag">  %<span class="title">head</span></span></span><br><span class="line"><span class="tag">    %<span class="title">title</span></span> Hampton Catlin Is Totally Awesome</span><br><span class="line"><span class="tag">    %<span class="title">meta</span>&#123;"http-equiv" =&gt; "Content-Type", <span class="symbol">:content</span> =&gt; <span class="string">"text/html; charset=utf-8"</span>&#125;</span></span><br><span class="line"><span class="tag">  %<span class="title">body</span></span></span><br><span class="line"><span class="tag">    %<span class="title">h1</span></span></span><br><span class="line">      This is very much like the standard template,</span><br><span class="line">      except that it has some ActionView-specific stuff.</span><br><span class="line">      It's only used for benchmarking.</span><br><span class="line">    .crazy_partials= render :partial =&gt; 'templates/av_partial_1'</span><br><span class="line"><span class="comment">    / You're In my house now!</span></span><br><span class="line">    .header</span><br><span class="line">      Yes, ladies and gentileman. He is just that egotistical.</span><br><span class="line">      Fantastic! This should be multi-line output</span><br><span class="line">      The question is if this would translate! Ahah!</span><br><span class="line">      =<span class="ruby"> <span class="number">1</span> + <span class="number">9</span> + <span class="number">8</span> + <span class="number">2</span> <span class="comment">#numbers should work and this should be ignored</span></span><br><span class="line"></span>    #body= " Quotes should be loved! Just like people!"</span><br><span class="line">    -<span class="ruby"> <span class="number">120</span>.times <span class="keyword">do</span> |number|</span><br><span class="line"></span>      -<span class="ruby"> number</span><br><span class="line"></span>    Wow.|</span><br><span class="line"><span class="tag">    %<span class="title">p</span></span></span><br><span class="line">      =<span class="ruby"> <span class="string">"Holy cow        "</span> + |</span><br><span class="line"></span>        "multiline       " + |</span><br><span class="line">        "tags!           " + |</span><br><span class="line">        "A pipe (|) even!"   |</span><br><span class="line">      =<span class="ruby"> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].collect &#123; |n| <span class="string">"PipesIgnored|"</span> &#125;</span><br><span class="line"></span>      =<span class="ruby"> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].collect &#123; |n|     |</span><br><span class="line"></span>          n.to_s                    |</span><br><span class="line">        &#125;.join("|")                 |</span><br><span class="line"><span class="tag">    %<span class="title">div</span><span class="value">.silent</span></span></span><br><span class="line">      -<span class="ruby"> foo = <span class="constant">String</span>.new</span><br><span class="line"></span>      -<span class="ruby"> foo &lt;&lt; <span class="string">"this"</span></span><br><span class="line"></span>      -<span class="ruby"> foo &lt;&lt; <span class="string">" shouldn't"</span></span><br><span class="line"></span>      -<span class="ruby"> foo &lt;&lt; <span class="string">" evaluate"</span></span><br><span class="line"></span>      =<span class="ruby"> foo + <span class="string">" but now it should!"</span></span><br><span class="line"></span><span class="comment">      -# Woah crap a comment!</span></span><br><span class="line"><span class="comment"></span><br><span class="line">    -# That was a line that shouldn't close everything.</span></span><br><span class="line"><span class="tag">    %<span class="title">ul</span><span class="value">.really</span><span class="value">.cool</span></span></span><br><span class="line">      -<span class="ruby"> (<span class="string">'a'</span>..<span class="string">'f'</span>).each <span class="keyword">do</span> |a|</span><br><span class="line"></span><span class="tag">        %<span class="title">li</span></span>= a</span><br><span class="line">    #combo.of_divs_with_underscore= @should_eval = "with this text"</span><br><span class="line">    =<span class="ruby"> [ <span class="number">104</span>, <span class="number">101</span>, <span class="number">108</span>, <span class="number">108</span>, <span class="number">111</span> ].map <span class="keyword">do</span> |byte|</span><br><span class="line"></span>      -<span class="ruby"> byte.chr</span><br><span class="line"></span>    .footer</span><br><span class="line"><span class="tag">      %<span class="title">strong</span><span class="value">.shout</span></span>= "This is a really long ruby quote. It should be loved and wrapped because its more than 50 characters. This value may change in the future and this test may look stupid. \nSo, I'm just making it *really* long. God, I hope this works"</span><br></pre></td></tr></table></figure></p>
<p>如果打算把现有的 erb 转成 haml，可以使用 haml 提供的一个命令行工具 html2haml，我们在 Gemfile 里安装台：</p>
<p>gem ‘html2haml’<br>在命令行里，直接使用它：</p>
<p>% html2haml -e index.erb index.haml<br>-e 参数，可以把 erb 模板转成 haml。<br><a href="http://html2haml.herokuapp.com/" target="_blank" rel="external">html2haml</a><br><a href="https://haml2erb.org/" target="_blank" rel="external">haml2erb</a></p>
<p>为了方便的使用 haml，尤其在使用 scaffold 或者 generate 创建文件的时候，自动创建 haml，而不是 erb。<br>可以安装 haml-rails：<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">gem</span> <span class="string">"haml-rails"</span></span><br></pre></td></tr></table></figure></p>
<p>它为我们提供了一个快速转换的工具：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">rake</span> <span class="rule"><span class="attribute">haml</span>:<span class="value">erb2haml</span></span></span><br></pre></td></tr></table></figure></p>
<p>它可以把所有 views 文件夹下的 erb 模板，转成 haml。</p>
<p>完整的Slim示例<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">doctype html</span><br><span class="line">html</span><br><span class="line">  head</span><br><span class="line">    title Slim Examples</span><br><span class="line">    meta name=<span class="string">"keywords"</span> content=<span class="string">"template language"</span></span><br><span class="line">    meta name=<span class="string">"author"</span> content=author</span><br><span class="line">    javascript:</span><br><span class="line">      alert(<span class="string">'Slim supports embedded javascript!'</span>)</span><br><span class="line"></span><br><span class="line">  body</span><br><span class="line">    h1 Markup examples</span><br><span class="line"></span><br><span class="line">    <span class="comment">#content</span></span><br><span class="line">      p This example shows you how <span class="operator">a</span> basic Slim <span class="built_in">file</span> looks like.</span><br><span class="line"></span><br><span class="line">      == yield</span><br><span class="line"></span><br><span class="line">      - unless <span class="keyword">items</span>.<span class="constant">empty</span>?</span><br><span class="line">        table</span><br><span class="line">          - <span class="keyword">for</span> <span class="keyword">item</span> <span class="operator">in</span> <span class="keyword">items</span> <span class="built_in">do</span></span><br><span class="line">            tr</span><br><span class="line">              td.name = <span class="keyword">item</span>.name</span><br><span class="line">              td.price = <span class="keyword">item</span>.price</span><br><span class="line">      - <span class="keyword">else</span></span><br><span class="line">        p</span><br><span class="line">         | No <span class="keyword">items</span> found.  Please <span class="built_in">add</span> some inventory.</span><br><span class="line">           Thank you!</span><br><span class="line"></span><br><span class="line">    <span class="operator">div</span> id=<span class="string">"footer"</span></span><br><span class="line">      = render <span class="string">'footer'</span></span><br><span class="line">      | Copyright © <span class="comment">#&#123;year&#125; #&#123;author&#125;</span></span><br></pre></td></tr></table></figure></p>
<p><a href="http://www.rubydoc.info/gems/slim/frames" target="_blank" rel="external">使用手册</a><br><a href="https://github.com/slim-template/html2slim" target="_blank" rel="external">html2slim</a><br><a href="https://github.com/slim-template/haml2slim" target="_blank" rel="external">haml2slim</a><br><a href="https://github.com/slim-template/slim-rails" target="_blank" rel="external">slim-rails</a><br><a href="http://html2slim.herokuapp.com/" target="_blank" rel="external">在线工具</a></p>
<p>devise 的邮件模板</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">config<span class="regexp">/environments/</span>development.rb：</span><br><span class="line"></span><br><span class="line">  config.action_mailer.default_url_options = &#123; <span class="string">host:</span> <span class="string">'localhost'</span>, <span class="string">port:</span> <span class="number">3000</span> &#125;</span><br><span class="line">  config.action_mailer.delivery_method = :smtp</span><br><span class="line">  config.action_mailer.smtp_settings = &#123;</span><br><span class="line"><span class="label">    address:</span>              <span class="string">'smtp.163.com'</span>,</span><br><span class="line"><span class="label">    port:</span>                 <span class="number">25</span>,</span><br><span class="line"><span class="label">    domain:</span>               <span class="string">'...'</span>,</span><br><span class="line"><span class="label">    user_name:</span>            <span class="string">'...@163.com'</span>,</span><br><span class="line"><span class="label">    password:</span>             <span class="string">'...'</span>,</span><br><span class="line"><span class="label">    authentication:</span>       :plain,</span><br><span class="line"><span class="label">    enable_starttls_auto:</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>同时，我们还需要修改 user 创建时的 migration 文件，打开 db/migrate/xxxx_devise_create_users.rb，我们取消注释这个部分：<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Confirmable</span></span><br><span class="line">  t.string   <span class="symbol">:confirmation_token</span></span><br><span class="line">  t.datetime <span class="symbol">:confirmed_at</span></span><br><span class="line">  t.datetime <span class="symbol">:confirmation_sent_at</span></span><br><span class="line">  t.string   <span class="symbol">:unconfirmed_email</span> <span class="comment"># Only if using reconfirmable</span></span><br></pre></td></tr></table></figure></p>
<p>config/initializers/devise.rb：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config<span class="class">.mailer_sender</span> = <span class="string">'...@163.com'</span></span><br><span class="line">...</span><br><span class="line">config<span class="class">.mailer</span> = <span class="string">'Devise::Mailer'</span></span><br></pre></td></tr></table></figure></p>
<p>为了让我们的邮件看起来更友好，我们编辑 app/views/users/mailer/confirmation_instructions.html.erb：<br><figure class="highlight erb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="title">p</span>&gt;</span>你好 </span>&lt;%=<span class="ruby"> <span class="variable">@email</span> </span>%&gt;<span class="xml">!<span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span>请点击下面的确认链接，验证您的邮箱:<span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">p</span>&gt;</span></span>&lt;%=<span class="ruby"> link_to <span class="string">"验证我的邮箱"</span>, confirmation_url(<span class="variable">@resource</span>, <span class="symbol">confirmation_token:</span> <span class="variable">@token</span>) </span>%&gt;<span class="xml"><span class="tag">&lt;/<span class="title">p</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p><code>user.confirm!</code> 方法激活用户</p>
<h2 id="Rails_中的模型">Rails 中的模型</h2><p>可以用 Actice Record 来做这几件事：</p>
<ul>
<li>表示模型（Model）和模型数据</li>
<li>表示模型间的关系（比如一对多，多对多关系）</li>
<li>通过模型间关联表示继承层次</li>
<li>在保存如数据库前，校验模型（比如属性校验）</li>
<li>用 面向对象 的方式处理数据库</li>
</ul>
<p>在数据库字段命名的时候，有几个特殊意义的名字，尽量回避：</p>
<ul>
<li>created_at - 创建记录时，自动设为当前的时间戳</li>
<li>updated_at - 更新记录时，自动设为当前的时间戳</li>
<li>lock_version - 在模型中添加乐观锁定功能</li>
<li>type - 让模型使用单表继承，给字段命名的时候，尽量避开这个词</li>
<li>(association_name)_type - 多态关联的类型</li>
<li>(table_name)_count - 保存关联对象的数量。例如，posts 表中的 comments_count 字段，Rails 会自动更新该文章的评论数</li>
</ul>
<p>rake db:migrate:redo [STEP=3] 直接回滚然后再次运行迁移，这样会方便些。</p>
<p>如果我们想回滚很久以前的某个操作，而且在那个迁移之后，我们已经执行了多个迁移。这时该如何处理呢？</p>
<p>如果在开发阶段，我们干脆 rake db:drop，rake db:create，rake db:migrate。但是在生产环境，我们决不能这么做，这时我们要针对需求，编写一个迁移文件：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChangeProductsPrice</span> <span class="inheritance">&lt; <span class="parent">ActiveRecord::Migration</span></span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">change</span></span></span><br><span class="line">    reversible <span class="keyword">do</span> |dir|</span><br><span class="line">      change_table <span class="symbol">:products</span> <span class="keyword">do</span> |t|</span><br><span class="line">        dir.up   &#123; t.change <span class="symbol">:price</span>, <span class="symbol">:string</span> &#125;</span><br><span class="line">        dir.down &#123; t.change <span class="symbol">:price</span>, <span class="symbol">:integer</span> &#125;</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>或者：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChangeProductsPrice</span> <span class="inheritance">&lt; <span class="parent">ActiveRecord::Migration</span></span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">up</span></span></span><br><span class="line">    change_table <span class="symbol">:products</span> <span class="keyword">do</span> |t|</span><br><span class="line">      t.change <span class="symbol">:price</span>, <span class="symbol">:string</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">down</span></span></span><br><span class="line">    change_table <span class="symbol">:products</span> <span class="keyword">do</span> |t|</span><br><span class="line">      t.change <span class="symbol">:price</span>, <span class="symbol">:integer</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>take  获取一个记录，不考虑任何顺序  个数  Product.take(2)</p>
<p>Product.find_by_name_and_price(“Hat”, 9.99)<br>up 是向前迁移到最新的，down用于回滚。</p>
<p>Where 查询<br>查询形式  实例<br>数组（Array）查询 Product.where(“name = ? and price = ?”, “T恤”, 9.99)<br>哈希（hash）查询  Product.where(name: “T恤”, price: 9.99)<br>Not查询 Product.where.not(price: 9.99)<br>空 Product.none</p>
<p>要更新全部记录，可以使用 update_all ：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Product.<span class="function"><span class="title">update_all</span><span class="params">(price: <span class="number">20</span>)</span></span></span><br></pre></td></tr></table></figure></p>
<p>update_all 会略过校验和回调，直接将数据写入到数据库中。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">product.<span class="function"><span class="title">update_column</span><span class="params">(:name, <span class="string">""</span>)</span></span></span><br><span class="line">product.<span class="function"><span class="title">update_columns</span><span class="params">(name: <span class="string">""</span>, price: <span class="number">0</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>使用 delete 删除时，会跳过回调，以及关联关系中定义的 :dependent 选项，直接从数据库中删除，它是一个类方法，比如：<br>Product.delete(1)</p>
<p>如果你不想真正从数据库中抹掉数据，而是给它一个删除标注.<br>可以使用 <a href="https://github.com/radar/paranoia" target="_blank" rel="external">https://github.com/radar/paranoia</a> 这个 gem.<br>他会给记录一个 deleted_at 时间戳，并且使用 restore 方法把它从数据库中恢复过来，或者使用 really_destroy! 将它真正的删除掉。</p>
</div><footer class="post__foot u-cf"><a href="/project/Rails/《Rails 实践》简略笔记.html#disqus_thread" class="post__foot-link u-fr">0 COMMENTS</a></footer></article><div class="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript></div></div></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2015 游悠品意</div><menu class="page-menu u-fr"><li class="page-menu__item"><span title="Previous" class="page-menu__link icon-arrow-left page-menu__link--disabled"></span></li><li class="page-menu__item"><span title="Next" class="page-menu__link icon-arrow-right page-menu__link--disabled"></span></li></menu></footer><script>(function(h,g,l,k,j,i){j=h.createElement(g),i=h.getElementsByTagName(g)[0],
j.src="//"+l+".disqus.com/"+k+".js",i.parentNode.insertBefore(j,i)})
(document,"script","yipinuu","embed");
</script></body></html>